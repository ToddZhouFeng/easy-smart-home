自动空调调节
======
&emsp;&emsp;从温湿度传感器中获取数据，再通过红外发射管遥控空调，从而保持在睡觉时空调温度达到舒适状态。

```flow
st=>start: 开始
op1=>operation: 获取数据
op2=>operation: 比较
op3=>operation: 调节
ed=>end: 结束

st->op1->op2->op3->ed
op3->op1
```

&emsp;&emsp;其中，获取数据部分不仅仅是获取传感器数据，而是根据最近几次的数据来判断将来的温湿度，从而在达到目标前提前调节。



```flow
st=>start: 开机
op=>operation: 每隔15min获取温度数据
cond=>condition: 预测是否太冷
high=>operation: 调低温度或保持不变
low=>operation: 调高温度
low_cond=>condition: 是否到最高
stop=>operation: 关闭空调
st->op->cond
cond(no)->high
high->op
cond(yes)->low_cond
low_cond(yes)->stop->op
low_cond(no)->low->op
```



# 零件

* Arduino nano
* 红外发射管
* 电池
* 充电板
* 开关



# 程序

## 红外发射部分

关于红外遥控的原理在此不再细讲，只大概讲一下如何获取编码：

1. 利用 IRremote 的 Example ：IRrecvDumpV2 获取数据（格式为数组）
2. 将数据利用 `irsend.sendRaw(irSignal, 199, khz);` 发送，其中，irSignal 为获取的数据，199 为数据长度，khz 为频率，一般为 38kHz

下面记录一下美的空调的编码（遥控器型号： RN51F/BG）

* 开机（制冷，20，中风）

  ```c
  unsigned int  rawData[199] = {4400,4400, 600,1550, 600,500, 600,1550, 600,1600, 550,500, 600,500, 600,1550, 600,500, 600,500, 550,1600, 600,500, 550,500, 600,1600, 600,1550, 600,500, 600,1550, 600,500, 600,1550, 600,500, 600,1550, 600,1600, 550,1600, 600,1550, 600,1600, 600,1550, 600,500, 550,1600, 600,500, 600,450, 600,500, 600,500, 600,450, 600,500, 600,500, 600,1550, 600,500, 600,500, 550,500, 600,500, 600,500, 550,1600, 600,1550, 600,500, 600,1550, 600,1600, 550,1600, 600,1550, 600,1600, 600,5150, 4500,4350, 600,1550, 600,500, 600,1550, 600,1600, 600,450, 600,500, 600,1550, 600,500, 600,500, 600,1550, 600,500, 600,500, 550,1600, 600,1550, 600,500, 600,1550, 600,500, 600,1550, 600,500, 600,1550, 600,1600, 600,1550, 600,1550, 600,1600, 600,1550, 600,500, 600,1550, 600,500, 600,500, 550,500, 600,500, 600,500, 600,450, 600,500, 600,1550, 600,500, 600,500, 600,450, 600,500, 600,500, 600,1550, 600,1600, 550,500, 600,1600, 550,1600, 600,1550, 600,1600, 550,1600, 600};  // 8a0820a222aa88000800a2aae8a0820a222aa88000800a2aa
  ```

* 关机

  ```c
  unsigned int  rawData[199] = {4450,4350, 600,1600, 600,450, 600,1600, 600,1550, 600,500, 600,500, 550,1600, 600,500, 550,500, 600,1600, 550,500, 600,500, 600,1550, 600,1600, 550,500, 600,1600, 600,450, 600,1600, 600,1550, 600,1600, 550,1600, 650,450, 600,1550, 600,1550, 600,1600, 550,500, 600,500, 600,500, 600,450, 600,1600, 550,500, 600,500, 600,1550, 600,1600, 600,1550, 600,500, 600,500, 550,500, 600,500, 600,500, 550,500, 600,500, 650,450, 600,1550, 600,1550, 600,1600, 650,1500, 600,1550, 600,5200, 4450,4400, 550,1600, 600,500, 600,1550, 600,1550, 600,500, 600,500, 600,1550, 600,500, 600,450, 600,1600, 600,500, 550,500, 600,1600, 550,1600, 600,500, 600,1550, 600,500, 550,1600, 600,1550, 600,1600, 550,1600, 600,500, 600,1550, 600,1600, 550,1600, 600,500, 550,500, 600,500, 600,500, 550,1600, 600,500, 550,500, 600,1600, 550,1600, 600,1550, 600,500, 600,500, 550,500, 600,500, 600,500, 600,450, 600,500, 600,500, 600,1550, 600,1600, 550,1600, 600,1550, 600,1600, 550};  // SAMSUNG B24D7B84
  ```

* 在制冷中风下，各温度的编码：

  17

  ```c
  unsigned int  rawData[199] = {4400,4400, 600,1550, 600,500, 600,1550, 600,1600, 550,550, 550,500, 600,1550, 600,550, 550,500, 600,1550, 600,500, 550,550, 550,1600, 600,1600, 550,500, 600,1550, 600,500, 600,1550, 600,500, 600,1550, 600,1600, 550,1600, 600,1550, 600,1600, 600,1550, 600,500, 550,1600, 600,500, 600,500, 550,550, 550,500, 600,500, 550,550, 550,500, 600,500, 550,550, 550,500, 600,500, 550,550, 550,500, 600,1600, 550,1600, 550,1600, 600,1550, 600,1600, 600,1550, 600,1550, 600,1600, 600,5150, 4500,4350, 600,1550, 600,550, 550,1550, 600,1600, 600,500, 550,550, 550,1600, 550,550, 550,500, 600,1550, 600,500, 600,500, 550,1600, 600,1550, 600,550, 550,1550, 600,550, 550,1550, 600,550, 550,1550, 600,1600, 600,1550, 600,1600, 550,1600, 600,1550, 600,500, 600,1550, 600,550, 550,500, 600,500, 550,550, 550,500, 550,550, 550,550, 550,500, 600,500, 550,550, 550,500, 600,500, 550,550, 550,1600, 550,1600, 600,1550, 600,1600, 600,1550, 600,1550, 600,1600, 600,1550, 600};  // 8a0820a222aa88000000aaaae8a0820a222aa88000000aaaa
  ```

  20

  ```c
  unsigned int  rawData[199] = {4450,4350, 600,1600, 550,500, 600,1600, 600,1550, 600,500, 600,450, 600,1600, 600,450, 600,500, 600,1600, 550,500, 600,500, 600,1550, 600,1600, 550,500, 600,1600, 600,450, 600,1600, 550,500, 600,1600, 600,1550, 600,1550, 600,1600, 600,1550, 600,1600, 550,500, 600,1600, 550,500, 600,500, 600,500, 550,500, 600,500, 600,500, 600,450, 600,1600, 550,500, 600,500, 600,500, 600,450, 600,500, 600,1550, 600,1600, 600,500, 550,1600, 600,1550, 600,1600, 550,1600, 600,1550, 600,5200, 4450,4400, 550,1600, 600,500, 550,1600, 600,1550, 600,500, 600,500, 550,1600, 600,500, 600,450, 600,1600, 600,500, 550,500, 600,1550, 600,1600, 600,500, 550,1600, 600,500, 550,1600, 600,500, 550,1600, 600,1550, 600,1600, 550,1600, 600,1550, 600,1600, 600,450, 600,1600, 600,450, 600,500, 600,500, 600,500, 550,500, 600,500, 600,500, 600,1550, 600,500, 550,500, 600,500, 600,500, 600,450, 600,1600, 550,1600, 600,500, 600,1550, 600,1550, 600,1600, 600,1550, 600,1600, 550};  // 8a0820a222aa88000800a2aae8a0820a222aa88000800a2aa
  ```

  23

  ```c
  unsigned int  rawData[199] = {4400,4400, 550,1600, 600,500, 550,1600, 600,1550, 600,500, 600,500, 600,1550, 600,500, 600,450, 600,1600, 600,450, 600,500, 600,1600, 550,1600, 600,500, 550,1600, 600,500, 550,1600, 600,500, 550,1600, 600,1550, 600,1600, 600,1550, 600,1550, 600,1600, 600,500, 550,1600, 600,500, 550,550, 550,500, 600,500, 550,500, 600,500, 600,1550, 600,500, 600,1550, 600,500, 600,500, 600,450, 600,500, 600,1550, 600,500, 600,1550, 600,500, 600,1600, 550,1600, 600,1550, 600,1600, 550,5200, 4500,4350, 600,1550, 600,500, 600,1550, 600,1600, 550,500, 600,500, 600,1550, 600,500, 600,500, 550,1600, 600,500, 600,450, 600,1600, 550,1600, 600,500, 600,1550, 600,500, 600,1550, 600,500, 600,1550, 600,1600, 550,1600, 600,1550, 600,1600, 550,1600, 600,500, 600,1550, 600,500, 600,450, 600,500, 600,500, 600,450, 600,500, 600,1600, 550,500, 600,1600, 550,500, 600,500, 600,500, 550,500, 600,1600, 550,500, 600,1600, 600,450, 600,1600, 600,1550, 600,1550, 600,1600, 600};  // 8a0820a222aa8800220088aae8a0820a222aa8800220088aa
  ```

  27

  ```c
  unsigned int  rawData[199] = {4450,4350, 600,1550, 600,550, 550,1550, 600,1600, 600,500, 550,550, 550,1550, 600,550, 550,500, 600,1550, 600,500, 600,500, 550,1600, 600,1550, 600,500, 600,1550, 600,500, 600,1550, 600,550, 550,1550, 600,1600, 600,1550, 600,1550, 600,1600, 600,1550, 600,500, 600,1550, 600,500, 600,500, 550,550, 550,500, 600,500, 550,1600, 600,500, 600,500, 550,1600, 550,550, 550,550, 550,500, 600,500, 550,550, 550,1550, 600,1600, 600,500, 550,1600, 600,1550, 600,1600, 550,1600, 600,5200, 4450,4350, 600,1600, 550,550, 550,1600, 550,1600, 600,500, 550,550, 550,1600, 600,500, 550,550, 550,1550, 600,550, 550,500, 600,1550, 600,1550, 600,550, 550,1600, 550,550, 550,1600, 550,550, 550,1600, 550,1600, 600,1550, 600,1600, 600,1550, 600,1550, 600,550, 550,1550, 600,550, 550,500, 600,500, 550,550, 550,500, 600,1550, 600,500, 600,500, 550,1600, 600,500, 550,550, 550,550, 550,500, 550,550, 550,1600, 600,1550, 600,500, 600,1550, 600,1550, 600,1600, 600,1550, 600};  // 8a0820a222aa8800820028aae8a0820a222aa8800820028aa
  ```

  

  

  30

  ```c
  unsigned int  rawData[199] = {4450,4350, 600,1550, 600,500, 600,1550, 600,1600, 550,500, 600,500, 600,1550, 600,500, 600,500, 600,1550, 600,500, 600,500, 550,1600, 600,1550, 600,500, 600,1550, 600,500, 600,1550, 600,500, 600,1550, 600,1600, 600,1550, 600,1550, 600,1600, 600,1550, 600,500, 600,1550, 600,500, 600,500, 550,500, 600,500, 600,500, 550,1600, 600,500, 600,1550, 600,1550, 600,500, 600,500, 600,450, 600,500, 600,500, 600,1550, 600,500, 600,500, 550,1600, 600,1550, 600,1600, 600,1550, 600,5200, 4450,4350, 600,1600, 550,500, 650,1550, 550,1600, 600,500, 550,500, 600,1600, 600,450, 600,500, 600,1550, 600,500, 600,500, 600,1550, 600,1550, 600,500, 600,1550, 600,500, 600,1600, 550,500, 600,1600, 600,1550, 600,1550, 600,1600, 600,1550, 600,1550, 600,500, 600,1550, 600,500, 600,500, 600,450, 600,500, 600,500, 600,1550, 600,500, 600,1550, 600,1600, 600,450, 600,500, 600,500, 550,500, 600,500, 600,1550, 600,500, 600,500, 550,1600, 600,1550, 600,1600, 600,1550, 600};  // 8a0820a222aa88008a0020aae8a0820a222aa88008a0020aa
  ```

目前来看并没有一种有效的方法压缩储存。尝试了多种简化方法，均以失败告终。



## 从DHT12获取数据

```c
#include <Wire.h>

void setup() {
  Serial.begin(9600);
  Serial.println("Start");
  Wire.begin();
}

void loop() {
  // put your main code here, to run repeatedly:
  Wire.beginTransmission(0x5C); //DHT12 的地址
  Wire.write(0); //向 DHT12 请求数据
  Wire.endTransmission();
  int bytes = Wire.requestFrom(0x5C, 5);
  uint8_t bits[5];
  for(int i=0;i<bytes;++i){
    bits[i]=Wire.read();
  }
  float humidity = bits[0] + bits[1]*0.1;
  float temperature = bits[2] + (bits[3] & 0x7F) * 0.1;
  if(bits[3] & 0x80){
    temperature = -temperature;
  }
  uint8_t checksum=bits[0]+bits[1]+bits[2]+bits[3];
  if(bits[4] != checksum){
    Serial.println("Error");
  }
  else{
    Serial.print("DHT12, \t");
    Serial.print(humidity, 1);
    Serial.print(",\t");
    Serial.println(temperature, 1);
  }
  delay(1000);
}
```



# 回归预测

由实验可以看出，开空调后，房间内的温度大体上呈对数形，但由于 Arduino 的数学运算并不强，而且温度数据可看作分段线性，故使用分段线性回归。

```c

int interval = 10; //预测的间隔时间
float aver_x = 5.5; //从1到interval的平均值
float a,b;//回归方程的参数
float y[] = {10, 9, 8, 7, 6, 5, 4, 3, 2, 1};//数量要等于interval

int get_ab(float y[]) {
  float aver_y = 0;
  for (int i = interval - 1; i >= 0; --i) {
    aver_y += y[i];
  }
  aver_y /= interval;

  float b_frac_up = 0;
  for (int i = interval; i; --i) {
    b_frac_up += (i * y[i - 1]);
  }
  b_frac_up-=(interval*aver_x*aver_y);

  float b_frac_down = 0;
  for(int i=interval;i;--i){
    b_frac_down += (i*i);
  }
  b_frac_down-=(interval*aver_x*aver_x);

  if(b_frac_down){
    b=b_frac_up/b_frac_down;
  }
  else return 0;

  a=aver_y-b*aver_x;
  return 1;
}

void setup() {
  // put your setup code here, to run once:
  Serial.begin(9600);
  get_ab(y);
  Serial.println(a);
  Serial.println(b);
}

void loop() {
  // put your main code here, to run repeatedly:
}
```

下面是利用10次数据（间隔1分钟）来预测10分钟后的温度的实测：

```c
15:46:26.436 -> Start
15:46:36.520 -> 27.4,27.4,27.4,27.4,27.4,27.4,27.4,27.4,27.4,27.4,
15:46:36.520 -> Temperature:27.4
15:46:36.661 -> send open
15:47:36.716 -> 27.4,27.4,27.4,27.4,27.4,27.4,27.4,27.4,27.4,27.4,
15:47:36.762 -> Temperature:27.4
15:47:36.903 -> send open
15:48:36.965 -> 27.4,27.4,27.4,27.4,27.4,27.4,27.4,27.4,27.4,27.5,
15:48:37.012 -> Temperature:27.5
15:48:37.153 -> send open
15:49:37.217 -> 27.4,27.4,27.4,27.4,27.4,27.4,27.4,27.4,27.5,27.6,
15:49:37.217 -> Temperature:27.6
15:49:37.358 -> send open
15:50:37.434 -> 27.4,27.4,27.4,27.4,27.4,27.4,27.4,27.5,27.6,27.7,
15:50:37.481 -> Temperature:27.9
15:50:37.622 -> send open
15:51:37.661 -> 27.4,27.4,27.4,27.4,27.4,27.4,27.5,27.6,27.7,27.6,
15:51:37.708 -> Temperature:27.9
15:51:37.848 -> send open
15:52:37.925 -> 27.4,27.4,27.4,27.4,27.4,27.5,27.6,27.7,27.6,27.7,
15:52:37.925 -> Temperature:28.1
15:52:38.066 -> send open
15:53:38.117 -> 27.4,27.4,27.4,27.4,27.5,27.6,27.7,27.6,27.7,27.7,
15:53:38.164 -> Temperature:28.1
15:53:38.305 -> send open
15:54:38.384 -> 27.4,27.4,27.4,27.5,27.6,27.7,27.6,27.7,27.7,27.7,
15:54:38.384 -> Temperature:28.2
15:54:38.524 -> send open
15:55:38.606 -> 27.4,27.4,27.5,27.6,27.7,27.6,27.7,27.7,27.7,27.7,
15:55:38.652 -> Temperature:28.1
15:55:38.793 -> send open
15:56:38.847 -> 27.4,27.5,27.6,27.7,27.6,27.7,27.7,27.7,27.7,27.7,
15:56:38.893 -> Temperature:28.0
15:56:38.987 -> send open
15:57:39.054 -> 27.5,27.6,27.7,27.6,27.7,27.7,27.7,27.7,27.7,27.7,
15:57:39.088 -> Temperature:27.9
15:57:39.224 -> send open
15:58:39.324 -> 27.6,27.7,27.6,27.7,27.7,27.7,27.7,27.7,27.7,27.7,
15:58:39.324 -> Temperature:27.8
15:58:39.465 -> send open
15:59:39.563 -> 27.7,27.6,27.7,27.7,27.7,27.7,27.7,27.7,27.7,27.7,
15:59:39.563 -> Temperature:27.8
15:59:39.715 -> send open
16:00:39.759 -> 27.6,27.7,27.7,27.7,27.7,27.7,27.7,27.7,27.7,27.7,
16:00:39.806 -> Temperature:27.8
16:00:39.922 -> send open
```



